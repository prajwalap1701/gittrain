name: Check PR Title and Jira State

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  check_pr_title_and_jira_state:
    runs-on: ubuntu-latest

    steps:
    - name: Check PR Title and Jira State
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
        JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      run: |
        # Extract the Jira ticket from the PR title
        jira_ticket=$(echo "$PR_TITLE" | grep -oP 'GC-\d+')

        if [[ -z $jira_ticket ]]; then
          echo "No Jira ticket (GC-[0-9]+) found in the PR title."
          exit 1
        fi

        # Fetch the Jira ticket state using the Jira REST API
        ticket_state=$(curl -s -u $GITHUB_ACTOR:$JIRA_API_TOKEN -X GET $JIRA_BASE_URL/rest/api/2/issue/$jira_ticket | jq -r '.fields.status.name')

        # Check the state and take appropriate action
        if [[ $ticket_state == "Done" ]]; then
          echo "The Jira ticket $jira_ticket is in a 'Done' state."
        elif [[ $ticket_state == "In Progress" ]]; then
          echo "The Jira ticket $jira_ticket is in 'In Progress' state."
        else
          echo "The Jira ticket $jira_ticket is in an unknown state: $ticket_state"
          exit 1
        fi
